<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>空間設計器 - iPhone 優化版</title>
    <style>
        :root { --primary: #4A90E2; --bg: #1a1a1a; --accent: #8e44ad; }
        
        /* 使用 dvh 確保在 Safari 導覽列出現時高度依然正確 */
        body { 
            font-family: "Microsoft JhengHei", sans-serif; 
            display: flex; 
            flex-direction: row; 
            margin: 0; 
            background-color: var(--bg); 
            height: 100dvh; 
            overflow: hidden; 
        }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100% !important; height: 45dvh; order: 2; border-top: 1px solid #444; }
            #canvas-container { 
                height: 55dvh; 
                order: 1; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                padding: 10px; 
                box-sizing: border-box;
                overflow-y: auto !important; /* 允許垂直捲動以看到被遮擋的部分 */
            }
        }

        #sidebar { width: 320px; padding: 15px; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; box-sizing: border-box; }
        
        /* 核心優化：增加底部間距防止被 iPhone 選單遮擋 */
        #canvas-container { 
            flex-grow: 1; 
            background: #333; 
            overflow: auto; 
            position: relative; 
            padding-bottom: 80px; 
            -webkit-overflow-scrolling: touch;
        }

        canvas { 
            background-color: white; 
            max-width: 100%; 
            max-height: 100%; 
            width: auto; height: auto;
            object-fit: contain; 
            display: block; 
            touch-action: none; 
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
            margin-bottom: 20px;
        }

        .accordion-header { display: flex; justify-content: space-between; align-items: center; background: #f1f3f5; padding: 10px; border-radius: 5px; cursor: pointer; border: 1px solid #ddd; margin-top: 10px; font-weight: bold; font-size: 14px; }
        .accordion-content { display: none; padding: 10px; border: 1px solid #ddd; border-top: none; background: #fff; }
        .accordion-content.active { display: block; }
        .item-list-li { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; font-size: 13px; }
        .item-list-li.selected { background: #e3f2fd; border-left: 4px solid var(--primary); }
        input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; margin-bottom: 8px; }
        .color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; margin-top: 5px; }
        .color-dot { width: 100%; aspect-ratio: 1; border-radius: 3px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
        button { width: 100%; padding: 10px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: bold; margin-bottom: 5px; }
        .btn-zone { background: var(--accent); }
        .btn-danger { background: #e74c3c; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 style="margin:0 0 10px 0;">空間設計 (iPhone優化)</h3>
    <button onclick="addFurniture()">＋ 新增家具</button>
    <button class="btn-zone" onclick="addZone()">＋ 新增底色區域</button>

    <div class="accordion-header active" onclick="toggleAccordion('listContent')">
        <span>家具清單 <small id="furnitureCount">(0)</small></span>
        <span>▼</span>
    </div>
    <div id="listContent" class="accordion-content active">
        <div id="furnitureListContainer"></div>
    </div>

    <div id="editPanel" style="display:none;">
        <div class="accordion-header active" onclick="toggleAccordion('furnitureContent')">
            <span>編輯家具</span>
            <span>▼</span>
        </div>
        <div id="furnitureContent" class="accordion-content active">
            <input type="text" id="editName" oninput="updateSelected()" placeholder="名稱">
            <div style="display: flex; gap: 5px;">
                <input type="number" id="editW" oninput="updateSelected()" placeholder="W (cm)">
                <input type="number" id="editH" oninput="updateSelected()" placeholder="H (cm)">
            </div>
            <div class="color-grid" id="colorGrid"></div>
            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <button style="background:#607d8b; flex:1;" onclick="rotateStep(-30)">↺ -30°</button>
                <button style="background:#607d8b; flex:1;" onclick="rotateStep(30)">+30° ↻</button>
            </div>
            <button class="btn-danger" style="width:100%; margin-top:10px;" onclick="deleteSelected()">刪除家具</button>
        </div>
    </div>

    <div class="accordion-header" onclick="toggleAccordion('zoneContent')">
        <span>區域管理</span>
        <span>▼</span>
    </div>
    <div id="zoneContent" class="accordion-content">
        <div id="zoneList"></div>
    </div>
</div>

<div id="canvas-container">
    <canvas id="roomCanvas" width="950" height="740"></canvas>
</div>

<script>
    const canvas = document.getElementById('roomCanvas');
    const ctx = canvas.getContext('2d');
    const CW = 950, CH = 740;
    const PRESET_COLORS = ["#ffb347", "#222222", "#aec6cf", "#77dd77", "#fdfd96", "#cfcfc4", "#ff6961", "#836953", "#c23b22", "#03c03c", "#5d8aa8", "#ffffff"];

    let furnitures = [], zones = [], selectedIndex = -1, isDragging = false, offset = { x: 0, y: 0 };

    initColorGrid();
    zones.push({ name: "走道", x: 0, y: 0, w: 150, h: 740, color: "#ffb347" });
    zones.push({ name: "柱子1", x: 430, y: 700, w: 40, h: 40, color: "#222222" });
    zones.push({ name: "柱子2", x: 430, y: 0, w: 40, h: 40, color: "#222222" });
    renderZoneList();

    function toggleAccordion(id) {
        document.getElementById(id).classList.toggle('active');
    }

    function initColorGrid() {
        const grid = document.getElementById('colorGrid');
        PRESET_COLORS.forEach(color => {
            const dot = document.createElement('div');
            dot.className = 'color-dot';
            dot.style.backgroundColor = color;
            dot.onclick = () => { if (selectedIndex !== -1) { furnitures[selectedIndex].color = color; } };
            grid.appendChild(dot);
        });
    }

    function addFurniture(name="新家具", x=200, y=200, w=100, h=100) {
        furnitures.push({ x: x-w/2, y: y-h/2, w, h, rotation: 0, name, color: "#aec6cf" });
        selectedIndex = furnitures.length - 1;
        updateUI();
    }

    function addZone() {
        zones.push({ name: "新區域", x: 200, y: 200, w: 100, h: 100, color: "#eeeeee" });
        renderZoneList();
    }

    function getContrastYIQ(hexcolor){
        hexcolor = hexcolor.replace("#", "");
        if(hexcolor.length === 3) hexcolor = hexcolor.split('').map(s => s+s).join('');
        var r = parseInt(hexcolor.substr(0,2),16);
        var g = parseInt(hexcolor.substr(2,2),16);
        var b = parseInt(hexcolor.substr(4,2),16);
        var yiq = ((r*299)+(g*587)+(b*114))/1000;
        return (yiq >= 128) ? '#000000' : '#ffffff';
    }

    function draw() {
        ctx.clearRect(0, 0, CW, CH);
        zones.forEach(z => {
            ctx.fillStyle = z.color;
            ctx.fillRect(z.x, CH - (z.y + z.h), z.w, z.h);
        });
        for (let i = 0; i <= CW; i += 50) {
            ctx.beginPath(); 
            ctx.strokeStyle = (i % 100 === 0) ? '#666' : '#999';
            ctx.lineWidth = (i % 100 === 0) ? 1.2 : 0.6;
            ctx.moveTo(i, 0); ctx.lineTo(i, CH); ctx.stroke();
            if (i % 100 === 0) {
                ctx.fillStyle = '#444'; ctx.font = 'bold 12px Arial';
                ctx.fillText(i, i + 2, CH - 5);
            }
        }
        for (let j = 0; j <= CH; j += 50) {
            ctx.beginPath();
            ctx.strokeStyle = (j % 100 === 0) ? '#666' : '#999';
            ctx.lineWidth = (j % 100 === 0) ? 1.2 : 0.6;
            ctx.moveTo(0, CH - j); ctx.lineTo(CW, CH - j); ctx.stroke();
            if (j % 100 === 0 && j !== 0) {
                ctx.fillStyle = '#444'; ctx.font = 'bold 12px Arial';
                ctx.fillText(j, 5, CH - j - 2);
            }
        }
        furnitures.forEach((f, idx) => {
            ctx.save();
            ctx.translate(f.x + f.w/2, CH - (f.y + f.h/2));
            ctx.rotate(-f.rotation * Math.PI / 180);
            ctx.fillStyle = f.color;
            ctx.strokeStyle = (idx === selectedIndex) ? '#4A90E2' : '#333';
            ctx.lineWidth = (idx === selectedIndex) ? 4 : 2;
            ctx.fillRect(-f.w/2, -f.h/2, f.w, f.h);
            ctx.strokeRect(-f.w/2, -f.h/2, f.w, f.h);
            ctx.fillStyle = getContrastYIQ(f.color);
            ctx.font = 'bold 24px "Microsoft JhengHei"';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.shadowColor = "rgba(0,0,0,0.3)";
            ctx.shadowBlur = 4;
            ctx.fillText(f.name, 0, 0);
            ctx.restore();
        });
        requestAnimationFrame(draw);
    }

    function getCoords(e) {
        const rect = canvas.getBoundingClientRect();
        const displayScale = rect.width / CW;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: (clientX - rect.left) / displayScale,
            y: CH - ((clientY - rect.top) / displayScale)
        };
    }

    function handleStart(e) {
        const c = getCoords(e);
        let found = false;
        for (let i = furnitures.length - 1; i >= 0; i--) {
            const f = furnitures[i];
            if (c.x >= f.x && c.x <= f.x + f.w && c.y >= f.y && c.y <= f.y + f.h) {
                selectedIndex = i; isDragging = true;
                offset.x = c.x - f.x; offset.y = c.y - f.y;
                found = true; break;
            }
        }
        if (!found) selectedIndex = -1;
        updateUI();
        if(found) e.preventDefault();
    }

    function handleMove(e) {
        if (!isDragging || selectedIndex === -1) return;
        const c = getCoords(e);
        furnitures[selectedIndex].x = c.x - offset.x;
        furnitures[selectedIndex].y = c.y - offset.y;
        e.preventDefault();
    }

    canvas.addEventListener('mousedown', handleStart);
    window.addEventListener('mousemove', handleMove);
    window.addEventListener('mouseup', () => isDragging = false);
    canvas.addEventListener('touchstart', handleStart, { passive: false });
    window.addEventListener('touchmove', handleMove, { passive: false });
    window.addEventListener('touchend', () => isDragging = false);

    function updateUI() {
        const panel = document.getElementById('editPanel');
        if (selectedIndex !== -1) {
            panel.style.display = 'block';
            const f = furnitures[selectedIndex];
            document.getElementById('editName').value = f.name;
            document.getElementById('editW').value = f.w;
            document.getElementById('editH').value = f.h;
        } else { panel.style.display = 'none'; }
        updateList();
    }

    function updateList() {
        const list = document.getElementById('furnitureListContainer');
        document.getElementById('furnitureCount').innerText = `(${furnitures.length})`;
        list.innerHTML = '';
        furnitures.forEach((f, idx) => {
            const li = document.createElement('div');
            li.className = `item-list-li ${idx === selectedIndex ? 'selected' : ''}`;
            li.innerHTML = `<span>${f.name}</span><small>${f.w}x${f.h} cm</small>`;
            li.onclick = () => { selectedIndex = idx; updateUI(); };
            list.appendChild(li);
        });
    }

    function renderZoneList() {
        const container = document.getElementById('zoneList');
        container.innerHTML = '';
        zones.forEach((z, idx) => {
            const div = document.createElement('div');
            div.style.borderBottom = '1px solid #eee'; div.style.padding = '8px 0';
            div.innerHTML = `
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="text" value="${z.name}" oninput="zones[${idx}].name=this.value" style="flex:1; font-size:12px; margin:0">
                    <button onclick="zones.splice(${idx},1);renderZoneList()" style="width:30px; background:#e74c3c; border:none; color:white;">✕</button>
                </div>
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:2px;">
                    <input type="number" value="${z.x}" oninput="zones[${idx}].x=parseFloat(this.value)||0">
                    <input type="number" value="${z.y}" oninput="zones[${idx}].y=parseFloat(this.value)||0">
                    <input type="number" value="${z.w}" oninput="zones[${idx}].w=parseFloat(this.value)||0">
                    <input type="number" value="${z.h}" oninput="zones[${idx}].h=parseFloat(this.value)||0">
                </div>
                <div class="color-grid" style="grid-template-columns: repeat(12, 1fr); margin-top:5px;">
                    ${PRESET_COLORS.map(c => `<div style="background:${c}; height:10px; cursor:pointer;" onclick="zones[${idx}].color='${c}'"></div>`).join('')}
                </div>`;
            container.appendChild(div);
        });
    }

    function updateSelected() {
        if (selectedIndex !== -1) {
            const f = furnitures[selectedIndex];
            f.name = document.getElementById('editName').value;
            f.w = parseFloat(document.getElementById('editW').value) || 1;
            f.h = parseFloat(document.getElementById('editH').value) || 1;
        }
    }
    function rotateStep(deg) { if (selectedIndex !== -1) furnitures[selectedIndex].rotation += deg; }
    function deleteSelected() { if (selectedIndex !== -1) { furnitures.splice(selectedIndex, 1); selectedIndex = -1; updateUI(); } }

    draw();
</script>
</body>
</html>
