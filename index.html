<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ¿é–“è¨­è¨ˆå™¨ - é™„æ“ä½œèªªæ˜ç‰ˆ</title>
    <style>
        :root { --primary: #4A90E2; --bg: #333; --accent: #8e44ad; }
        body { font-family: "Microsoft JhengHei", sans-serif; display: flex; flex-direction: row; margin: 0; background-color: var(--bg); height: 100vh; overflow: hidden; }
        
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100% !important; height: 45vh; order: 2; border-top: 2px solid #555; }
            #canvas-container { height: 55vh; order: 1; }
        }

        #sidebar { width: 320px; padding: 15px; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; box-sizing: border-box; }
        #canvas-container { flex-grow: 1; background: #222; overflow: auto; display: block; position: relative; -webkit-overflow-scrolling: touch; }
        canvas { background-color: white; display: block; margin: 20px; touch-action: none; }

        /* æ‘ºç–Šé¢æ¿ */
        .accordion-header { 
            display: flex; justify-content: space-between; align-items: center;
            background: #f8f9fa; padding: 10px; border-radius: 5px; cursor: pointer;
            border: 1px solid #ddd; margin-top: 10px; font-weight: bold; color: #333;
        }
        .accordion-header.active { background: #eef1f4; border-bottom: none; border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        .accordion-content { 
            display: none; padding: 10px; border: 1px solid #ddd; border-top: none;
            border-bottom-left-radius: 5px; border-bottom-right-radius: 5px; background: #fff;
        }
        .accordion-content.active { display: block; }
        .arrow { transition: transform 0.3s; font-size: 0.8em; }
        .active .arrow { transform: rotate(180deg); }

        /* ä½¿ç”¨èªªæ˜æ¨£å¼ */
        .guide-box { 
            background: #fff9db; border: 1px solid #ffec99; padding: 10px; 
            border-radius: 5px; margin-bottom: 10px; font-size: 0.85em; color: #856404;
            line-height: 1.5;
        }
        .guide-box b { color: #d9480f; }

        /* æ¸…å–®æ¨£å¼ */
        .item-list-li { 
            padding: 8px 12px; border-bottom: 1px solid #eee; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center; font-size: 14px;
        }
        .item-list-li.selected { background: #e3f2fd; border-left: 4px solid var(--primary); font-weight: bold; }
        
        .control-panel { border: 1px solid #ddd; padding: 10px; border-radius: 8px; background: #fafafa; }
        input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; margin-bottom: 8px; }
        
        .color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; margin-top: 5px; }
        .color-dot { width: 100%; aspect-ratio: 1; border-radius: 4px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
        .color-dot.active { border: 2px solid #000; }

        button { width: 100%; padding: 10px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: bold; margin-bottom: 5px; }
        .btn-zone { background: var(--accent); }
        .btn-danger { background: #e74c3c; margin-top: 8px; }
        .rotate-group { display: flex; gap: 5px; margin-top: 5px; }
        .btn-secondary { background: #607d8b; flex: 1; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2>æˆ¿é–“è¨­è¨ˆ Pro</h2>
    <button onclick="addFurniture()">ï¼‹ æ–°å¢å®¶å…·</button>
    <button class="btn-zone" onclick="addZone()">ï¼‹ æ–°å¢åº•è‰²å€åŸŸ</button>

    <div class="accordion-header active" onclick="toggleAccordion('listContent')">
        <span>å®¶å…·æ¸…å–® <small id="furnitureCount">(0)</small></span>
        <span class="arrow">â–¼</span>
    </div>
    <div id="listContent" class="accordion-content active">
        <div id="furnitureListContainer"></div>
    </div>

    <div id="editPanel" style="display:none;">
        <div class="accordion-header active" onclick="toggleAccordion('furnitureContent')">
            <span>ç·¨è¼¯é¸ä¸­å®¶å…·</span>
            <span class="arrow">â–¼</span>
        </div>
        <div id="furnitureContent" class="accordion-content active">
            <div class="control-panel">
                <input type="text" id="editName" oninput="updateSelected()" placeholder="åç¨±">
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="editW" oninput="updateSelected()" placeholder="é•· W">
                    <input type="number" id="editH" oninput="updateSelected()" placeholder="å¯¬ H">
                </div>
                <div class="color-grid" id="colorGrid"></div>
                <div class="rotate-group">
                    <button class="btn-secondary" onclick="rotateStep(-30)">â†º -30Â°</button>
                    <button class="btn-secondary" onclick="rotateStep(30)">+30Â° â†»</button>
                </div>
                <button class="btn-danger" onclick="deleteSelected()">åˆªé™¤æ­¤å®¶å…·</button>
            </div>
        </div>
    </div>

    <div class="accordion-header" id="zoneHeader" onclick="toggleAccordion('zoneContent')">
        <span>åº•è‰²å€åŸŸç®¡ç†</span>
        <span class="arrow">â–¼</span>
    </div>
    <div id="zoneContent" class="accordion-content">
        <div class="guide-box">
            <b>ğŸ“ ä½¿ç”¨è¦å‰‡ï¼š</b><br>
            â€¢ åŸé» (0,0) ä½æ–¼ç•«å¸ƒ<b>å·¦ä¸‹è§’</b>ã€‚<br>
            â€¢ <b>X / Y</b>ï¼šå€åŸŸå·¦ä¸‹è§’çš„åº§æ¨™ä½ç½®ã€‚<br>
            â€¢ <b>W / H</b>ï¼šå€åŸŸå‘å³èˆ‡å‘ä¸Šçš„å°ºå¯¸ã€‚<br>
            â€¢ <b>åœ–å±¤</b>ï¼šå€åŸŸæ°¸é é¡¯ç¤ºåœ¨å®¶å…·ä¸‹æ–¹ã€‚
        </div>
        <div id="zoneList"></div>
    </div>
</div>

<div id="canvas-container">
    <canvas id="roomCanvas" width="950" height="740"></canvas>
</div>

<script>
    const canvas = document.getElementById('roomCanvas');
    const ctx = canvas.getContext('2d');
    const FIXED_W = 950, FIXED_H = 740;
    const PRESET_COLORS = ["#aec6cf", "#ffb347", "#77dd77", "#fdfd96", "#cfcfc4", "#ff6961", "#836953", "#c23b22", "#03c03c", "#5d8aa8", "#222222", "#ffffff"];

    let furnitures = [], zones = [], selectedIndex = -1, isDragging = false, offset = { x: 0, y: 0 };

    initColorGrid();
    addZone("é è¨­åœ°æ¿", 0, 0, 950, 740, "#f9f9f9");
    addFurniture("å¤§æ²™ç™¼", 50, 50, 200, 90);

    function toggleAccordion(id) {
        const content = document.getElementById(id);
        content.classList.toggle('active');
        content.previousElementSibling.classList.toggle('active');
    }

    function initColorGrid() {
        const grid = document.getElementById('colorGrid');
        PRESET_COLORS.forEach(color => {
            const dot = document.createElement('div');
            dot.className = 'color-dot';
            dot.style.backgroundColor = color;
            dot.onclick = () => { if (selectedIndex !== -1) { furnitures[selectedIndex].color = color; } };
            grid.appendChild(dot);
        });
    }

    function addFurniture(name="æ–°å®¶å…·", x=100, y=100, w=100, h=80) {
        furnitures.push({ x, y, w, h, rotation: 0, name, color: PRESET_COLORS[0] });
        selectedIndex = furnitures.length - 1;
        updateUI();
    }

    function updateFurnitureList() {
        const listContainer = document.getElementById('furnitureListContainer');
        const countSpan = document.getElementById('furnitureCount');
        listContainer.innerHTML = '';
        countSpan.innerText = `(${furnitures.length})`;

        furnitures.forEach((f, idx) => {
            const li = document.createElement('div');
            li.className = `item-list-li ${idx === selectedIndex ? 'selected' : ''}`;
            li.innerHTML = `<span>${idx + 1}. ${f.name}</span><small style="color:#888">${f.w}x${f.h}</small>`;
            li.onclick = () => { selectedIndex = idx; updateUI(); };
            listContainer.appendChild(li);
        });
    }

    function draw() {
        ctx.clearRect(0, 0, FIXED_W, FIXED_H);
        zones.forEach(z => { ctx.fillStyle = z.color; ctx.fillRect(z.x, FIXED_H - (z.y + z.h), z.w, z.h); });
        ctx.strokeStyle = '#e0e0e0';
        for (let i = 0; i <= FIXED_W; i += 50) {
            ctx.beginPath(); ctx.lineWidth = (i % 100 === 0) ? 1.5 : 0.5;
            ctx.moveTo(i, 0); ctx.lineTo(i, FIXED_H); ctx.stroke();
            if (i % 100 === 0) { ctx.fillStyle = '#999'; ctx.font = '12px Arial'; ctx.fillText(i, i+2, FIXED_H-5); }
        }
        for (let j = 0; j <= FIXED_H; j += 50) {
            ctx.beginPath(); ctx.lineWidth = (j % 100 === 0) ? 1.5 : 0.5;
            ctx.moveTo(0, FIXED_H-j); ctx.lineTo(FIXED_W, FIXED_H-j); ctx.stroke();
            if (j % 100 === 0) { ctx.fillStyle = '#999'; ctx.fillText(j, 5, FIXED_H-j-2); }
        }
        furnitures.forEach((f, idx) => {
            ctx.save();
            ctx.translate(f.x + f.w/2, FIXED_H - (f.y + f.h/2));
            ctx.rotate(-f.rotation * Math.PI / 180);
            ctx.fillStyle = f.color;
            ctx.strokeStyle = (idx === selectedIndex) ? '#4A90E2' : '#333';
            ctx.lineWidth = (idx === selectedIndex) ? 4 : 2;
            ctx.fillRect(-f.w/2, -f.h/2, f.w, f.h);
            ctx.strokeRect(-f.w/2, -f.h/2, f.w, f.h);
            ctx.fillStyle = '#333'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(f.name, 0, 0);
            ctx.restore();
        });
        requestAnimationFrame(draw);
    }

    function updateUI() {
        const panel = document.getElementById('editPanel');
        if (selectedIndex !== -1) {
            panel.style.display = 'block';
            const f = furnitures[selectedIndex];
            document.getElementById('editName').value = f.name;
            document.getElementById('editW').value = f.w;
            document.getElementById('editH').value = f.h;
            Array.from(document.querySelectorAll('#colorGrid .color-dot')).forEach(dot => {
                dot.classList.toggle('active', dot.style.backgroundColor === f.color);
            });
        } else { panel.style.display = 'none'; }
        updateFurnitureList();
    }

    function updateSelected() {
        if (selectedIndex !== -1) {
            const f = furnitures[selectedIndex];
            f.name = document.getElementById('editName').value;
            f.w = parseFloat(document.getElementById('editW').value) || 1;
            f.h = parseFloat(document.getElementById('editH').value) || 1;
            updateFurnitureList();
        }
    }

    // åº§æ¨™èˆ‡äº‹ä»¶è™•ç†
    function getCoords(e) {
        const rect = canvas.getBoundingClientRect();
        const cx = e.touches ? e.touches[0].clientX : e.clientX;
        const cy = e.touches ? e.touches[0].clientY : e.clientY;
        return { x: cx - rect.left, y: FIXED_H - (cy - rect.top) };
    }
    canvas.addEventListener('mousedown', e => {
        const c = getCoords(e);
        let found = false;
        for (let i = furnitures.length - 1; i >= 0; i--) {
            const f = furnitures[i];
            if (c.x >= f.x && c.x <= f.x + f.w && c.y >= f.y && c.y <= f.y + f.h) {
                selectedIndex = i; isDragging = true;
                offset.x = c.x - f.x; offset.y = c.y - f.y;
                found = true; break;
            }
        }
        if (!found) selectedIndex = -1;
        updateUI();
    });
    window.addEventListener('mousemove', e => {
        if (isDragging && selectedIndex !== -1) {
            const c = getCoords(e);
            furnitures[selectedIndex].x = c.x - offset.x;
            furnitures[selectedIndex].y = c.y - offset.y;
        }
    });
    window.addEventListener('mouseup', () => isDragging = false);

    canvas.addEventListener('touchstart', e => {
        const c = getCoords(e);
        let found = false;
        for (let i = furnitures.length - 1; i >= 0; i--) {
            const f = furnitures[i];
            if (c.x >= f.x && c.x <= f.x + f.w && c.y >= f.y && c.y <= f.y + f.h) {
                selectedIndex = i; isDragging = true;
                offset.x = c.x - f.x; offset.y = c.y - f.y;
                found = true; break;
            }
        }
        if (!found) selectedIndex = -1;
        updateUI();
        if(found) e.preventDefault();
    }, {passive: false});
    window.addEventListener('touchmove', e => {
        if (isDragging) {
            const c = getCoords(e);
            furnitures[selectedIndex].x = c.x - offset.x;
            furnitures[selectedIndex].y = c.y - offset.y;
            e.preventDefault();
        }
    }, {passive: false});
    window.addEventListener('touchend', () => isDragging = false);

    function rotateStep(deg) { if (selectedIndex !== -1) furnitures[selectedIndex].rotation += deg; }
    function deleteSelected() { if (selectedIndex !== -1) { furnitures.splice(selectedIndex, 1); selectedIndex = -1; updateUI(); } }

    function addZone(name="åº•è‰²å€", x=0, y=0, w=300, h=300, color="#f0f0f0") {
        zones.push({ name, x, y, w, h, color });
        renderZoneList();
        document.getElementById('zoneContent').classList.add('active');
        document.getElementById('zoneHeader').classList.add('active');
    }

    function renderZoneList() {
        const container = document.getElementById('zoneList');
        container.innerHTML = '';
        zones.forEach((z, idx) => {
            const div = document.createElement('div');
            div.style.borderBottom = '1px solid #eee'; div.style.padding = '8px 0';
            div.innerHTML = `
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="text" value="${z.name}" oninput="zones[${idx}].name=this.value" style="flex:1; font-size:12px; margin:0">
                    <button class="btn-danger" onclick="zones.splice(${idx},1);renderZoneList()" style="width:30px; margin:0; padding:5px">âœ•</button>
                </div>
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:3px;">
                    <input type="number" value="${z.x}" oninput="zones[${idx}].x=parseFloat(this.value)||0">
                    <input type="number" value="${z.y}" oninput="zones[${idx}].y=parseFloat(this.value)||0">
                    <input type="number" value="${z.w}" oninput="zones[${idx}].w=parseFloat(this.value)||0">
                    <input type="number" value="${z.h}" oninput="zones[${idx}].h=parseFloat(this.value)||0">
                </div>
                <div class="color-grid" style="grid-template-columns: repeat(12, 1fr); margin-top:5px;">
                    ${PRESET_COLORS.map(c => `<div style="background:${c}; height:12px; cursor:pointer;" onclick="zones[${idx}].color='${c}'"></div>`).join('')}
                </div>
            `;
            container.appendChild(div);
        });
    }

    draw();
</script>
</body>
</html>
