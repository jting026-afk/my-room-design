<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç©ºé–“è¨­è¨ˆå™¨ - 950x740 å®Œæ•´ç‰ˆ</title>
    <style>
        :root { --primary: #4A90E2; --bg: #1a1a1a; --accent: #8e44ad; }
        body { font-family: "Microsoft JhengHei", sans-serif; display: flex; flex-direction: row; margin: 0; background-color: var(--bg); height: 100vh; overflow: hidden; }
        
        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100% !important; height: 45vh; order: 2; border-top: 2px solid #444; }
            #canvas-container { height: 55vh; order: 1; display: flex; align-items: center; justify-content: center; padding: 5px; box-sizing: border-box; }
        }

        #sidebar { width: 320px; padding: 15px; background: white; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; box-sizing: border-box; }
        #canvas-container { flex-grow: 1; background: #333; overflow: hidden; position: relative; }
        
        canvas { 
            background-color: white; 
            max-width: 100%; 
            max-height: 100%; 
            width: auto; height: auto;
            object-fit: contain; 
            display: block; 
            touch-action: none; 
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
        }

        .accordion-header { display: flex; justify-content: space-between; align-items: center; background: #f1f3f5; padding: 10px; border-radius: 5px; cursor: pointer; border: 1px solid #ddd; margin-top: 10px; font-weight: bold; font-size: 14px; }
        .accordion-header.active { background: #eef1f4; }
        .accordion-content { display: none; padding: 10px; border: 1px solid #ddd; border-top: none; background: #fff; }
        .accordion-content.active { display: block; }
        
        .guide-box { background: #fff9db; border: 1px solid #ffec99; padding: 8px; border-radius: 4px; font-size: 12px; color: #856404; margin-bottom: 10px; }
        .item-list-li { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; font-size: 13px; }
        .item-list-li.selected { background: #e3f2fd; border-left: 4px solid var(--primary); }

        input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; margin-bottom: 8px; }
        .color-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 4px; margin-top: 5px; }
        .color-dot { width: 100%; aspect-ratio: 1; border-radius: 3px; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }
        
        button { width: 100%; padding: 10px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 5px; font-weight: bold; margin-bottom: 5px; }
        .btn-zone { background: var(--accent); }
        .btn-danger { background: #e74c3c; margin-top: 5px; font-size: 12px; padding: 5px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 style="margin:0 0 10px 0;">ç©ºé–“è¨­è¨ˆ (950x740)</h3>
    <button onclick="addFurniture()">ï¼‹ æ–°å¢å®¶å…·</button>
    <button class="btn-zone" onclick="addZone()">ï¼‹ æ–°å¢åº•è‰²å€åŸŸ</button>

    <div class="accordion-header active" onclick="toggleAccordion('listContent')">
        <span>å®¶å…·æ¸…å–® <small id="furnitureCount">(0)</small></span>
        <span>â–¼</span>
    </div>
    <div id="listContent" class="accordion-content active">
        <div id="furnitureListContainer"></div>
    </div>

    <div id="editPanel" style="display:none;">
        <div class="accordion-header active" onclick="toggleAccordion('furnitureContent')">
            <span>ç·¨è¼¯å®¶å…·å±¬æ€§</span>
            <span>â–¼</span>
        </div>
        <div id="furnitureContent" class="accordion-content active">
            <input type="text" id="editName" oninput="updateSelected()" placeholder="åç¨±">
            <div style="display: flex; gap: 5px;">
                <input type="number" id="editW" oninput="updateSelected()" placeholder="å¯¬ W (cm)">
                <input type="number" id="editH" oninput="updateSelected()" placeholder="é•· H (cm)">
            </div>
            <div class="color-grid" id="colorGrid"></div>
            <div style="display: flex; gap: 5px; margin-top: 5px;">
                <button style="background:#607d8b; flex:1;" onclick="rotateStep(-30)">â†º -30Â°</button>
                <button style="background:#607d8b; flex:1;" onclick="rotateStep(30)">+30Â° â†»</button>
            </div>
            <button class="btn-danger" style="width:100%;" onclick="deleteSelected()">åˆªé™¤æ­¤å®¶å…·</button>
        </div>
    </div>

    <div class="accordion-header" id="zoneHeader" onclick="toggleAccordion('zoneContent')">
        <span>åº•è‰²å€åŸŸç®¡ç†</span>
        <span>â–¼</span>
    </div>
    <div id="zoneContent" class="accordion-content">
        <div class="guide-box">
            <b>ğŸ“ å€åŸŸè¦å‰‡ï¼š</b><br>
            â€¢ åŸé» (0,0) ç‚º<b>å·¦ä¸‹è§’</b>ã€‚<br>
            â€¢ X, Yï¼šå€åŸŸå·¦ä¸‹è§’ä¹‹åº§æ¨™ã€‚<br>
            â€¢ å€åŸŸé¡¯ç¤ºæ–¼å®¶å…·çš„æœ€åº•å±¤ã€‚
        </div>
        <div id="zoneList"></div>
    </div>
</div>

<div id="canvas-container">
    <canvas id="roomCanvas" width="950" height="740"></canvas>
</div>

<script>
    const canvas = document.getElementById('roomCanvas');
    const ctx = canvas.getContext('2d');
    const CW = 950, CH = 740;
    const PRESET_COLORS = ["#aec6cf", "#ffb347", "#77dd77", "#fdfd96", "#cfcfc4", "#ff6961", "#836953", "#c23b22", "#03c03c", "#5d8aa8", "#222222", "#ffffff"];

    let furnitures = [], zones = [], selectedIndex = -1, isDragging = false, offset = { x: 0, y: 0 };

    initColorGrid();
    addZone("é è¨­ç©ºé–“", 0, 0, CW, CH, "#f8f9fa");
    addFurniture("å±•ç¤ºå€", 475, 370, 150, 150);

    function toggleAccordion(id) {
        document.getElementById(id).classList.toggle('active');
        document.getElementById(id).previousElementSibling.classList.toggle('active');
    }

    function initColorGrid() {
        const grid = document.getElementById('colorGrid');
        PRESET_COLORS.forEach(color => {
            const dot = document.createElement('div');
            dot.className = 'color-dot';
            dot.style.backgroundColor = color;
            dot.onclick = () => { if (selectedIndex !== -1) { furnitures[selectedIndex].color = color; } };
            grid.appendChild(dot);
        });
    }

    function addFurniture(name="æ–°å®¶å…·", x=100, y=100, w=100, h=100) {
        furnitures.push({ x: x-w/2, y: y-h/2, w, h, rotation: 0, name, color: PRESET_COLORS[0] });
        selectedIndex = furnitures.length - 1;
        updateUI();
    }

    function addZone(name="æ–°åº•è‰²å€", x=0, y=0, w=300, h=300, color="#f0f0f0") {
        zones.push({ name, x, y, w, h, color });
        renderZoneList();
        document.getElementById('zoneContent').classList.add('active');
        document.getElementById('zoneHeader').classList.add('active');
    }

    function draw() {
        ctx.clearRect(0, 0, CW, CH);
        
        // 1. ç¹ªè£½åº•è‰²å€åŸŸ
        zones.forEach(z => {
            ctx.fillStyle = z.color;
            ctx.fillRect(z.x, CH - (z.y + z.h), z.w, z.h);
        });

        // 2. ç¹ªè£½æ¯”ä¾‹ç¶²æ ¼ (æ¯ 100cm ä¸€æ ¼)
        ctx.strokeStyle = '#e0e0e0';
        for (let i = 0; i <= CW; i += 50) {
            ctx.beginPath(); ctx.lineWidth = (i%100===0)?1.5:0.5; ctx.moveTo(i, 0); ctx.lineTo(i, CH); ctx.stroke();
            if (i%100===0) { ctx.fillStyle = '#aaa'; ctx.font='12px Arial'; ctx.fillText(i, i+2, CH-5); }
        }
        for (let j = 0; j <= CH; j += 50) {
            ctx.beginPath(); ctx.lineWidth = (j%100===0)?1.5:0.5; ctx.moveTo(0, CH-j); ctx.lineTo(CW, CH-j); ctx.stroke();
            if (j%100===0) { ctx.fillStyle = '#aaa'; ctx.fillText(j, 5, CH-j-2); }
        }

        // 3. ç¹ªè£½å®¶å…·
        furnitures.forEach((f, idx) => {
            ctx.save();
            ctx.translate(f.x + f.w/2, CH - (f.y + f.h/2));
            ctx.rotate(-f.rotation * Math.PI / 180);
            ctx.fillStyle = f.color;
            ctx.strokeStyle = (idx === selectedIndex) ? '#4A90E2' : '#333';
            ctx.lineWidth = (idx === selectedIndex) ? 4 : 2;
            ctx.fillRect(-f.w/2, -f.h/2, f.w, f.h);
            ctx.strokeRect(-f.w/2, -f.h/2, f.w, f.h);
            ctx.fillStyle = '#333'; ctx.textAlign = 'center'; ctx.textBaseline='middle'; ctx.fillText(f.name, 0, 0);
            ctx.restore();
        });
        requestAnimationFrame(draw);
    }

    // ç¸®æ”¾åº§æ¨™è™•ç†
    function getCoords(e) {
        const rect = canvas.getBoundingClientRect();
        const displayScale = rect.width / CW;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        return {
            x: (clientX - rect.left) / displayScale,
            y: CH - ((clientY - rect.top) / displayScale)
        };
    }

    function handleStart(e) {
        const c = getCoords(e);
        let found = false;
        for (let i = furnitures.length - 1; i >= 0; i--) {
            const f = furnitures[i];
            if (c.x >= f.x && c.x <= f.x + f.w && c.y >= f.y && c.y <= f.y + f.h) {
                selectedIndex = i; isDragging = true;
                offset.x = c.x - f.x; offset.y = c.y - f.y;
                found = true; break;
            }
        }
        if (!found) selectedIndex = -1;
        updateUI();
        if(found) e.preventDefault();
    }

    function handleMove(e) {
        if (!isDragging || selectedIndex === -1) return;
        const c = getCoords(e);
        furnitures[selectedIndex].x = c.x - offset.x;
        furnitures[selectedIndex].y = c.y - offset.y;
        e.preventDefault();
    }

    canvas.addEventListener('mousedown', handleStart);
    window.addEventListener('mousemove', handleMove);
    window.addEventListener('mouseup', () => isDragging = false);
    canvas.addEventListener('touchstart', handleStart, { passive: false });
    window.addEventListener('touchmove', handleMove, { passive: false });
    window.addEventListener('touchend', () => isDragging = false);

    function updateUI() {
        const panel = document.getElementById('editPanel');
        if (selectedIndex !== -1) {
            panel.style.display = 'block';
            const f = furnitures[selectedIndex];
            document.getElementById('editName').value = f.name;
            document.getElementById('editW').value = f.w;
            document.getElementById('editH').value = f.h;
        } else { panel.style.display = 'none'; }
        updateList();
    }

    function updateList() {
        const list = document.getElementById('furnitureListContainer');
        document.getElementById('furnitureCount').innerText = `(${furnitures.length})`;
        list.innerHTML = '';
        furnitures.forEach((f, idx) => {
            const li = document.createElement('div');
            li.className = `item-list-li ${idx === selectedIndex ? 'selected' : ''}`;
            li.innerHTML = `<span>${f.name}</span><small>${f.w}x${f.h} cm</small>`;
            li.onclick = () => { selectedIndex = idx; updateUI(); };
            list.appendChild(li);
        });
    }

    function updateSelected() {
        if (selectedIndex !== -1) {
            const f = furnitures[selectedIndex];
            f.name = document.getElementById('editName').value;
            f.w = parseFloat(document.getElementById('editW').value) || 1;
            f.h = parseFloat(document.getElementById('editH').value) || 1;
        }
    }
    
    function renderZoneList() {
        const container = document.getElementById('zoneList');
        container.innerHTML = '';
        zones.forEach((z, idx) => {
            const div = document.createElement('div');
            div.style.borderBottom = '1px solid #eee'; div.style.padding = '8px 0';
            div.innerHTML = `
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="text" value="${z.name}" oninput="zones[${idx}].name=this.value" style="flex:1; font-size:12px; margin:0">
                    <button onclick="zones.splice(${idx},1);renderZoneList()" style="width:30px; background:#e74c3c; border:none; color:white; border-radius:3px;">âœ•</button>
                </div>
                <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:2px;">
                    <input type="number" value="${z.x}" oninput="zones[${idx}].x=parseFloat(this.value)||0">
                    <input type="number" value="${z.y}" oninput="zones[${idx}].y=parseFloat(this.value)||0">
                    <input type="number" value="${z.w}" oninput="zones[${idx}].w=parseFloat(this.value)||0">
                    <input type="number" value="${z.h}" oninput="zones[${idx}].h=parseFloat(this.value)||0">
                </div>
                <div class="color-grid" style="grid-template-columns: repeat(12, 1fr); margin-top:5px;">
                    ${PRESET_COLORS.map(c => `<div style="background:${c}; height:10px; cursor:pointer;" onclick="zones[${idx}].color='${c}'"></div>`).join('')}
                </div>`;
            container.appendChild(div);
        });
    }

    function rotateStep(deg) { if (selectedIndex !== -1) furnitures[selectedIndex].rotation += deg; }
    function deleteSelected() { if (selectedIndex !== -1) { furnitures.splice(selectedIndex, 1); selectedIndex = -1; updateUI(); } }

    draw();
</script>
</body>
</html>
